<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD><TITLE>Berlios:Projekt:netzworkk:Doku:kwtools</TITLE>
        <meta name="generator" content="quanta">
        <meta name="keywords" lang="en" content="Netzworkk, Netzwerk, netzworkk, kwtools, rsync">
        <meta name="description" lang="en" content="">
        <meta name="author" content="Kai Wilke / netzworkk.de">
        <meta name="publisher" content="Kai Wilke / netzworkk.de">
        <meta name="copyright" content="Kai Wilke / netzworkk.de">
        <meta name="date" content="2010-06-07">
        <meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
        <meta name="content-language" content="de">
	<meta name="Robots" content="index,follow">
	<link rel="icon" href="../../../images/favicon.ico" type="image/ico">
        <LINK href="../../../css/style.css" type=text/css rel=stylesheet>
</HEAD>
<BODY>
<TABLE cellSpacing=0 cellPadding=0 width="100%" border=0>
        <TBODY>
                <TR>
                        <TD width="2%" height=15></TD>
                        <TD width="96%"></TD>
                        <TD width="2%"></TD>
                </TR>
                <tr>
                        <td></td>
                        <td vAlign=top><center><a href="../../../doku/kwtools/net/kwrsync.html" target="Context"><img src="../../../images/arraw_l.gif" width="20" height="20" border="0"></a>
                                <img src="../../../images/trans.gif" width="15" height="8" border="0">
                                <a href="../../../doku/kwtools/net.html" target="Context"><img src="../../../images/arraw_h.gif" width="20" height="20" border="0"></a></center><br><hr><br></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><h2><a name=kwrsync_backup>kwrsync_backup</a></h2>
                                <p>kwrsync_backup zieht ein Momentaufnahme (Snapshot) von Rechnern und kann das 
				Backup Verzeichnis rotieren. kwrsync_backup_cron kann vom Cron D&auml;mon gestartet 
				werden und macht das gleiche wie kwrsync_backup im Hintergrund.</p></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><br><hr><br></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><p><img src="../../../images/trans.gif" width="0" height="1"><a href="kwrsync_backup.html#config">1 Konfiguration</a></p></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><p><img src="../../../images/trans.gif" width="0" height="1"><a href="kwrsync_backup.html#backup">2 Backup</a></p></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><p><img src="../../../images/trans.gif" width="0" height="1"><a href="kwrsync_backup.html#rotate">3 Rotierung</a></p></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><p><img src="../../../images/trans.gif" width="0" height="1"><a href="kwrsync_backup.html#info">4 Beachtenswertes</a></p></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><p><img src="../../../images/trans.gif" width="0" height="1"><a href="kwrsync_backup.html#links">5 Links</a></p></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><br><hr><br></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><h3><a name=config></a>1 Konfiguration</a></h3>
				<p>Hier kann man kwrsync_backup konfigurieren</p>
				<p><b>Ausschluss_Datei</b> Hier kann man eine Datei bearbeiten, in der die 
				Verzeichnisse und Dateien stehen die nicht mit ins Backup fliessen sollen.
				Sie sollten z.B. die Verzeichnisse /proc und /sys nicht miteinbeziehen, da sie
				nicht f&uuml;r die Wiederherstellung ben&ouml;tigt werden.</p>
				<p><b>Backupverz.</b> In welchem Verzeichnis sollen die Backups gespeichert 
				werden. Diese liegen dann unter Backupverz/Rechner/snapshot.0. Es gibt max. 7 
				Sicherungsverzeichnisse (snapshot.0-6).</p>
				<p><b>Bandbreite</b> Manchmal kann es sinnvoll sein die Bandbreite, der 
				&Uuml;bertragung zu limitieren. Geben Sie hier einen Wert in Kbyte/s an (100 = 100 
				KByte/s.</p>
				<p><b>Check_Platz</b> Soll gepr&uuml;ft werden, ob noch ein gewisser Prozentsatz
				an Plattenplatz und Inodes frei ist (ja/nein)?</p>
				<p><b>Minimum_Platz</b> Geben Sie hier den Prozentsatz ein der maximal an
				Plattenplatz benutzt werden darf. Denken Sie daran das die
				Rotierung der Daten auch etwas Platz ben&ouml;tigt. Integerzahl zwischen
				0 und <100 (Prozent). Ist die benutzte Kilobyte oder Inode Prozentzahl kleiner
				als die angegebene maximale Prozentzahl an Plattenplatz
				($HDMINFREE), wird ein Backup durchgef&uuml;hrt.</p>
				<p><b>Mountverz.</b> Hier wird das Verzeichnis ausgew&auml;hlt, welches ins
				Dateisystem vorher eingebunden werden muss, wo sich das Backup
				Verzeichnis befindet. Es muss bereits in der /etc/fstab konfiguriert
				sein.</p>
				<p><b>Remote_shell</b> Welche Shell soll f&uuml;r &Uuml;bertragung genutzt werden.
				Zur Auswahl stehen ssh und rsh, falls sie installiert sind. Der ssh
				besitzt eine Kompression und &uuml;bertr&auml;gt alles verschl&uuml;sselt.</p>
				<p><b>Server</b> Server die zu sichern sind, getrennt durch ein
				Leerzeichen. Dies k&ouml;nnen IP-Adressen, Rechnernamen oder
				Rechnenername.domain.de (FQDN) sein.</p>
				<p><b>User</b> W&auml;hlen Sie einen Benutzer aus, der sich anstelle von "root"
				auf den zu sichernden Rechnern einloggen darf. Es werden
				nur Benutzer angeboten die auf diesem System installiert
				sind.</p>
				<p><b>crontab</b> Das Script kwrsync_backup_cron in die crontab Tabelle vom
				Benutzer "root" einf&uuml;gen oder l&ouml;schen. Dieses Script f&uuml;hrt die
				Sicherung im Hintergrund aus und schickt bei Fehlern eine
				Mail.</p>
				<p><b>speichern</b> Beim speichern wird &uuml;berpr&uuml;ft, ob der Benutzer "root"
				schon eine Datei ~/.ssh/id_dsa.pub besitzt. Wenn nicht wird
				eine angelegt. Dabei wird auch gleich eine Datei
				~/.ssh/authorized_keys.rsync angelegt, die den richtigen
				"rsync" Befehl enth&auml;lt. Diese Datei k&ouml;nnen Sie anschliessend auf
				die zu sichernden Rechner (~/.ssh/authorized_keys, pr&uuml;fen
				Sie Ihre "ssh" Konfiguration), in das Verzeichnis des
				ausgew&auml;hlten Benutzers, kopieren.</p></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><br><hr><br></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><h3><a name=backup></a>2 Backup</a></h3>
				<p>Erstellt eine Momentaufnahme von den Rechnern, die in der Konfigurationsdatei 
				eingestellt wurden.</p></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><br><hr><br></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><h3><a name=rotate></a>3 Rotierung</a></h3>
				<p>Rotiert das Backup Verzeichnis. Dies geschieht per Hardlink-Kopie, so das nicht 
				nennenswerter zus&auml;tzlicher, Speicherplatz ben&ouml;tigt wird. Dabei wird aus snapshot.0
				--> snapshot.1, aus snapshot.1 --> snapshot.2, u.s.w.. Dabei wird immer die
				&auml;lteste Version (snapshot.7) gel&ouml;scht.</p></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><br><hr><br></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><h3><a name=info></a>4 Beachtenswertes</a></h3>
				<p>Sie sollten einen eigenen User (Bsp.:rsyncbackup) f&uuml;r kwrsync_backup
				auf den Backup Rechnern und den zu sichernden Rechnern erstellen, damit
				sich der Benutzer "root" nicht dauernd einloggen muss.
				Diesen User kann man dann mit dem Programm sudo das Ausf&uuml;hren des "rsync" 
				Kommandos zulassen. Mit "passwd User -l" kann man dem Backup User das Login
				auf den zu sichernden Rechnern verbieten.<br>
				- Loggen Sie sich auf jeden Backup Rechner, als "root", ein und erzeugen einen ssh 
				Key (ssh-keygen -t dsa), ohne Passphrase. Bei Frage nach der Passphrase einfach 
				Enter dr&uuml;cken.<br>
				- Auf den Backup Rechnern kopieren Sie die Datei 
				/root/.ssh/id-dsa.pub nach /root/.ssh/authorized_keys. Dort tragen Sie das "rsync" 
				Kommando command="sudo rsync --server --sender -vlogDtHAXprz  --delete-excluded 
				--numeric-ids . /" vor dem Key ein (command="sudo rsync ... ssh-dss AAA....).<br>
				- Diese Datei kopieren Sie auf jeden Host der zu sichern ist, 
				ins Home Verzeichnis des Backup Users (~/.ssh/authorized_keys).<br>
				<b>Notiz:</b> Achten Sie darauf das, auf allen Rechnern, in der Datei 
				/etc/ssh/sshd_config beim Parameter AuthorizedKeysFile      %h/.ssh/authorized_keys 
				steht.</p>
				<p>Sichern Sie den Backup Benutzer, durch das Programm "sudo" wie im Beispiel ab (Datei 
				/etc/sudoers). F&uuml;r die zu sichernden Rechner k&ouml;nnte das so aussehen:<br>
				# Host alias specification<br>
				# in diesem Fall nat&uuml;rlich der lokale Rechner<br>
				Host_Alias BACKUP_HOST = backuphost.domain.de<br>
				# User alias specification<br>
				User_Alias BACKUP_USER = kwrsyncbackup<br>
				# Cmnd alias specification<br>
				Cmnd_Alias KWRSYNC_BACKUP_CRON = /usr/bin/rsync<br>
				# User privilege specification<br>
				root    ALL=(ALL) ALL<br>
				BACKUP_USER   BACKUP_HOST=NOPASSWD: KWRSYNC_BACKUP_CRON</p>
				<p>Der User kwrsyncbackup (BACKUP_USER) darf auf dem Rechner backuphost.domain.de 
				(BACKUP_HOST) das Kommando (KWRSYNC_BACKUP_CRON) /usr/bin/rsync, ohne 
				Passwort ausf&uuml;hren.</p>
												
				<p><b>Notiz:</b> Programme die auf Dateiebene sichern sollten vor dem Backup ihre Daten 
				sichern, damit ihre Backups nicht inkonsestent sind (Bsp.: Datenbanken).
				Bei postresql kann man sich ein Script, mit folgendem Inhalt, schreiben:<br>
				pg_dumpall | gzip >/var/lib/postgres/fulldump.sql.gz.</p></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><br><hr><br></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><h3><a name=links></a>5 Links</a></h3>
				<p><a href="http://www.heinlein-support.de/web/wissen/rsync-backup/">http://www.heinlein-su
				pport.de/web/wissen/rsync-backup/</a><br>
				<a href="http://www.linux-magazin.de/Artikel/ausgabe/2004/09/backups/backups.html">
				http://www.linux-magazin.de/Artikel/ausgabe/2004/09/backups/backups.html</a></p></td>
                        <td></td>
                </tr>
                <tr>
                        <td></td>
                        <td vAlign=top><br><hr><br><center><a href="../../../doku/kwtools/net/kwrsync.html" target="Context"><img src="../../../images/arraw_l.gif" width="20" height="20" border="0"></a>
                                <img src="../../../images/trans.gif" width="15" height="8" border="0">
                                <a href="../../../doku/kwtools/net.html" target="Context"><img src="../../../images/arraw_h.gif" width="20" height="20" border="0"></a></center></td>
                        <td></td>
                </tr>
        </TBODY>
</TABLE>
</BODY>
</HTML>
