# tlsproxy (?) Konfiguration einstellen{{{

tlsproxy_conf() {

	# Variable
	TLSPROXY_TITLE="${gv_Configuration}::${lv_TlsProxy}"
	
	# Bestehende Konfiguration einlesen# {{{
	print -l ${(M)${(f)"$(postconf -c $MAIL_CONFIG)"}##(#s)tlsproxy_*} | \
		sed -e 's#\"#\\\"#g ; s# = #="#g ; s# =#="#g ;
		s#\$#\\\$#g ; s#$#"#g' >${gv_WorkDir}/postfix$$
	read_file -f ${gv_WorkDir}/postfix$$
	rm -rf  ${gv_WorkDir}/postfix$$ &>/dev/null
	## }}}
	# Funktion (conf_tlsproxy_menu), die tlsproxy-Parameter einstellen# {{{
	##############################################
	# TODO: Hilfe etc. vorbereitet
	# tlsproxy_enforce_tls = $smtpd_enforce_tls
	# tlsproxy_tls_CAfile = $smtpd_tls_CAfile
	# tlsproxy_tls_CApath = $smtpd_tls_CApath
	# tlsproxy_tls_always_issue_session_ids = $smtpd_tls_always_issue_session_ids
	# tlsproxy_tls_ask_ccert = $smtpd_tls_ask_ccert
	# tlsproxy_tls_ccert_verifydepth = $smtpd_tls_ccert_verifydepth
	# tlsproxy_tls_cert_file = $smtpd_tls_cert_file
	# tlsproxy_tls_ciphers = $smtpd_tls_ciphers
	# tlsproxy_tls_dcert_file = $smtpd_tls_dcert_file
	# tlsproxy_tls_dh1024_param_file = $smtpd_tls_dh1024_param_file
	# tlsproxy_tls_dh512_param_file = $smtpd_tls_dh512_param_file
	# tlsproxy_tls_dkey_file = $smtpd_tls_dkey_file
	# tlsproxy_tls_eccert_file = $smtpd_tls_eccert_file
	# tlsproxy_tls_eckey_file = $smtpd_tls_eckey_file
	# tlsproxy_tls_eecdh_grade = $smtpd_tls_eecdh_grade
	# tlsproxy_tls_exclude_ciphers = $smtpd_tls_exclude_ciphers
	# tlsproxy_tls_fingerprint_digest = $smtpd_tls_fingerprint_digest
	# tlsproxy_tls_key_file = $smtpd_tls_key_file
	# tlsproxy_tls_loglevel = $smtpd_tls_loglevel
	# tlsproxy_tls_mandatory_ciphers = $smtpd_tls_mandatory_ciphers
	# tlsproxy_tls_mandatory_exclude_ciphers = $smtpd_tls_mandatory_exclude_ciphers
	# tlsproxy_tls_mandatory_protocols = $smtpd_tls_mandatory_protocols
	# tlsproxy_tls_protocols = $smtpd_tls_protocols
	# tlsproxy_tls_req_ccert = $smtpd_tls_req_ccert
	# tlsproxy_tls_security_level = $smtpd_tls_security_level
	# tlsproxy_tls_session_cache_timeout = $smtpd_tls_session_cache_timeout
	# tlsproxy_use_tls = $smtpd_use_tls
	# tlsproxy_watchdog_timeout = 10s
	##############################################
	conf_tlsproxy_menu() {
		TLSPROXY_MENU=(tlsproxy_enforce_tls \"\$tlsproxy_enforce_tls\"
		tlsproxy_tls_CAfile \"\$tlsproxy_tls_CAfile\"
		tlsproxy_tls_CApath \"\$tlsproxy_tls_CApath\"
		tlsproxy_tls_always_issue_session_ids \"\$tlsproxy_tls_always_issue_session_ids\"
		tlsproxy_tls_ask_ccert \"\$tlsproxy_tls_ask_ccert\"
		tlsproxy_tls_ccert_verifydepth \"\$tlsproxy_tls_ccert_verifydepth\"
		tlsproxy_tls_cert_file \"\$tlsproxy_tls_cert_file\"
		tlsproxy_tls_ciphers \"\$tlsproxy_tls_ciphers\"
		tlsproxy_tls_dcert_file \"\$tlsproxy_tls_dcert_file\"
		tlsproxy_tls_dh1024_param_file \"\$tlsproxy_tls_dh1024_param_file\"
		tlsproxy_tls_dh512_param_file \"\$tlsproxy_tls_dh512_param_file\"
		tlsproxy_tls_dkey_file \"\$tlsproxy_tls_dkey_file\"
		tlsproxy_tls_eccert_file \"\$tlsproxy_tls_eccert_file\"
		tlsproxy_tls_eckey_file \"\$tlsproxy_tls_eckey_file\"
		tlsproxy_tls_eecdh_grade \"\$tlsproxy_tls_eecdh_grade\"
		tlsproxy_tls_exclude_ciphers \"\$tlsproxy_tls_exclude_ciphers\"
		tlsproxy_tls_fingerprint_digest \"\$tlsproxy_tls_fingerprint_digest\"
		tlsproxy_tls_key_file \"\$tlsproxy_tls_key_file\"
		tlsproxy_tls_loglevel \"\$tlsproxy_tls_loglevel\"
		tlsproxy_tls_mandatory_ciphers \"\$tlsproxy_tls_mandatory_ciphers\"
		tlsproxy_tls_mandatory_exclude_ciphers \"\$tlsproxy_tls_mandatory_exclude_ciphers\"
		tlsproxy_tls_mandatory_protocols \"\$tlsproxy_tls_mandatory_protocols\"
		tlsproxy_tls_protocols \"\$tlsproxy_tls_protocols\"
		tlsproxy_tls_req_ccert \"\$tlsproxy_tls_req_ccert\"
		tlsproxy_tls_security_level \"\$tlsproxy_tls_security_level\"
		tlsproxy_tls_session_cache_timeout \"\$tlsproxy_tls_session_cache_timeout\"
		tlsproxy_use_tls \"\$tlsproxy_use_tls\"
		tlsproxy_watchdog_timeout \"\$tlsproxy_watchdog_timeout\"
		postfix \"reload\"
		$gv_Back \"\")
		if [[ ${#argv} == 1 ]] ; then
			menubox -d "$1" "$TLSPROXY_TITLE" "$gv_Menupoint" "$TLSPROXY_MENU"
		else
			menubox "$TLSPROXY_TITLE" "$gv_Menupoint" "$TLSPROXY_MENU"
		fi
	}
	## }}}
	conf_tlsproxy_menu
	while [ "$gv_Auswahl" ] ; do
		case "$gv_Auswahl" in
			HELP*)	script_help tlsproxy_help
				conf_tlsproxy_menu
				;;
			tlsproxy_enforce_tls)
				# Standard = $smtpd_enforce_tls (no)# {{{
				default_or_input tlsproxy_enforce_tls ja_nein_tausch $TLSPROXY_TITLE $SMTPD_ENFORCE_TLS_MSG
				if [[ -n $Value ]] ; then
					tlsproxy_enforce_tls="$Value"
					postconf -e tlsproxy_enforce_tls="$Value"
				fi
				## }}}
				conf_tlsproxy_menu tlsproxy_enforce_tls
				;;
			tlsproxy_tls_CAfile)
				# Standard = $smtpd_tls_CAfile # {{{
				# Datei mit den CAs denen dieser Server vertraut, f√ºr die Signatur
				# von Clientzertifikaten.
				default_or_input tlsproxy_tls_CAfile tls_file_auswahl 
				tlsproxy_tls_CAfile="$Value"
				postconf -e tlsproxy_tls_CAfile="$Value"
				## }}}
				conf_tlsproxy_menu tlsproxy_tls_CAfile
				;;
			tlsproxy_tls_CApath)
				# Standard = $smtpd_tls_CApath# {{{
				# Verzeichnis in dem die Zertifikate liegen, fuer
				# ausgehende Mails. Diese werden dann mit den Rechten des Mail 
				# Servers gelesen. 
				dselect "$tlsproxy_tls_CApath"
				if [ "$VERZ" ] ; then
					dselect_check "$VERZ"
					if [ "$VERZ" ] ; then
						tlsproxy_tls_CApath="$VERZ"
						postconf -e tlsproxy_tls_CApath="$VERZ"
					else
						tlsproxy_tls_CApath=""
						postconf -e tlsproxy_tls_CApath=""
					fi
				fi
				## }}}
				conf_tlsproxy_menu tlsproxy_tls_CApath
				;;
			tlsproxy_tls_always_issue_session_ids)
				# = $smtpd_tls_always_issue_session_ids
				conf_tlsproxy_menu tlsproxy_tls_always_issue_session_ids
				;;
			tlsproxy_tls_ask_ccert)
				# Standard = $smtpd_tls_ask_ccert# {{{
				# Muss beim Server explizit nach einem Client Zertifikat
				# nachgefragt werden (ja/nein)?
				default_or_input tlsproxy_tls_ask_ccert ja_nein_tausch $TLSPROXY_TITLE $SMTPD_TLS_ASK_CCERT_MSG
				if [[ -n $Value ]] ; then
					tlsproxy_tls_ask_ccert="$Value"
					postconf -e tlsproxy_tls_ask_ccert="$Value"
				fi
				## }}}
				conf_tlsproxy_menu tlsproxy_tls_ask_ccert
				;;
			tlsproxy_tls_ccert_verifydepth)
				# = $smtpd_tls_ccert_verifydepth
				conf_tlsproxy_menu tlsproxy_tls_ccert_verifydepth
				;;
			tlsproxy_tls_cert_file)
				# = $smtpd_tls_cert_file
				conf_tlsproxy_menu tlsproxy_tls_cert_file
				;;
			tlsproxy_tls_ciphers)
				# = $smtpd_tls_ciphers
				conf_tlsproxy_menu tlsproxy_tls_ciphers
				;;
			tlsproxy_tls_dcert_file)
				# = $smtpd_tls_dcert_file
				conf_tlsproxy_menu tlsproxy_tls_dcert_file
				;;
			tlsproxy_tls_dh1024_param_file)
				# = $smtpd_tls_dh1024_param_file
				conf_tlsproxy_menu tlsproxy_tls_dh1024_param_file
				;;
			tlsproxy_tls_dh512_param_file)
				# = $smtpd_tls_dh512_param_file
				conf_tlsproxy_menu tlsproxy_tls_dh512_param_file
				;;
			tlsproxy_tls_dkey_file)
				# = $smtpd_tls_dkey_file
				conf_tlsproxy_menu tlsproxy_tls_dkey_file
				;;
			tlsproxy_tls_eccert_file)
				# = $smtpd_tls_eccert_file# {{{
				# Datei mit dem Postfix SMTP Server ECDSA
				# Zertifikat im PEM Format.
				default_or_input tlsproxy_tls_eccert_file tls_file_auswahl 
				tlsproxy_tls_eccert_file="$Value"
				postconf -e tlsproxy_tls_eccert_file="$Value"
				## }}}
				conf_tlsproxy_menu tlsproxy_tls_eccert_file
				;;
			tlsproxy_tls_eckey_file)
				# = $smtpd_tls_eckey_file# {{{
				# Datei mit dem Postfix SMTP Server ECDSA
				# privaten Schluessel im PEM Format.
				default_or_input tlsproxy_tls_eckey_file tls_file_auswahl 
				tlsproxy_tls_eckey_file="$Value"
				postconf -e tlsproxy_tls_eckey_file="$Value"
				## }}}
				conf_tlsproxy_menu tlsproxy_tls_eckey_file
				;;
			tlsproxy_tls_eecdh_grade)
				# = $smtpd_tls_eecdh_grade
				conf_tlsproxy_menu tlsproxy_tls_eecdh_grade
				;;
			tlsproxy_tls_exclude_ciphers)
				# = $smtpd_tls_exclude_ciphers
				conf_tlsproxy_menu tlsproxy_tls_exclude_ciphers
				;;
			tlsproxy_tls_fingerprint_digest)
				# = $smtpd_tls_fingerprint_digest
				conf_tlsproxy_menu tlsproxy_tls_fingerprint_digest
				;;
			tlsproxy_tls_key_file)
				# Standard ist = $smtpd_tls_key_file#{{{
				# Datei mit dem Postfix SMTP Server RSA
				# privaten Schluessel im PEM Format.
				default_or_input tlsproxy_tls_key_file tls_file_auswahl 
				tlsproxy_tls_key_file="$Value"
				postconf -e tlsproxy_tls_key_file="$Value"
				#}}}
				conf_tlsproxy_menu tlsproxy_tls_key_file
				;;
			tlsproxy_tls_loglevel)
				# = $smtpd_tls_loglevel# {{{
				default_or_input tlsproxy_tls_loglevel loglevel
				if [[ -n $Value ]] ; then
					tlsproxy_tls_loglevel="$Value"
					postconf -e tlsproxy_tls_loglevel="$Value"
				fi
				## }}}
				conf_tlsproxy_menu tlsproxy_tls_loglevel
				;;
			tlsproxy_tls_mandatory_ciphers)
				# = $smtpd_tls_mandatory_ciphers
				conf_tlsproxy_menu tlsproxy_tls_mandatory_ciphers
				;;
			tlsproxy_tls_mandatory_exclude_ciphers)
				# = $smtpd_tls_mandatory_exclude_ciphers
				conf_tlsproxy_menu tlsproxy_tls_mandatory_exclude_ciphers
				;;
			tlsproxy_tls_mandatory_protocols)
				# = $smtpd_tls_mandatory_protocols
				conf_tlsproxy_menu tlsproxy_tls_mandatory_protocols
				;;
			tlsproxy_tls_protocols)
				# = $smtpd_tls_protocols
				conf_tlsproxy_menu tlsproxy_tls_protocols
				;;
			tlsproxy_tls_req_ccert)
				# Standard = $smtpd_tls_req_ccert (no)# {{{
				default_or_input tlsproxy_tls_req_ccert ja_nein_tausch $TLSPROXY_TITLE $SMTPD_TLS_REQ_CCERT_MSG
				if [[ -n $Value ]] ; then
					tlsproxy_tls_req_ccert="$Value"
					postconf -e tlsproxy_tls_req_ccert="$Value"
				fi
				## }}}
				conf_tlsproxy_menu tlsproxy_tls_req_ccert
				;;
			tlsproxy_tls_security_level)
				# = $smtpd_tls_security_level
				conf_tlsproxy_menu tlsproxy_tls_security_level
				;;
			tlsproxy_tls_session_cache_timeout)
				# = $smtpd_tls_session_cache_timeout# {{{
				default_or_input tlsproxy_tls_session_cache_timeout number_input -s ${tlsproxy_tls_session_cache_timeout%?}
				if [[ -n $Value ]] ; then
					tlsproxy_tls_session_cache_timeout="$Value"
					postconf -e tlsproxy_tls_session_cache_timeout="$Value"
				fi
				## }}}
				conf_tlsproxy_menu tlsproxy_tls_session_cache_timeout
				;;
			tlsproxy_use_tls)
				# Standard = $smtpd_use_tls (no)# {{{
				default_or_input tlsproxy_use_tls ja_nein_tausch $TLSPROXY_TITLE $SMTPD_USE_TLS_MSG
				if [[ -n $Value ]] ; then
					tlsproxy_use_tls="$Value"
					postconf -e tlsproxy_use_tls="$Value"
				fi
				## }}}
				conf_tlsproxy_menu tlsproxy_use_tls
				;;
			tlsproxy_watchdog_timeout)
				# Standard ist = 10s, gehen aber auch Integer Zahlen mit dem Suffix d(day),# {{{
				# s(seconds), m(minutes), h(hourly), w(weekly) .
				################################################
				# TODO: *_MSG vervollstaendigen
				################################################
				TLSPROXY_WATCHDOG_TIMEOUT_MSG=$(gettext 'Sie koennen eine Integer Zahl in Sekunden, Minuten, Stunden Tagen oder Wochen eingeben. Benutzen Sie die einzelnen Suffixe \"smhdw\".')
				number_input -a "$TLSPROXY_TITLE" "$TLSPROXY_WATCHDOG_TIMEOUT_MSG" $tlsproxy_watchdog_timeout
				if [[ -n $NUMBER ]] ; then
					tlsproxy_watchdog_timeout="$NUMBER"
					postconf -e tlsproxy_watchdog_timeout="$NUMBER"
				fi
				## }}}
				conf_tlsproxy_menu tlsproxy_watchdog_timeout
				;;
			postfix)
				# postfix, Konfiguration neu einlesen
				postfix_start_reload
				break
				;;
			$gv_Back)	break
				;;
		esac
	done
}
#}}}
### Modeline {{{
### vim:ft=zsh:foldmethod=marker
### vim:set ts=4:                                                                               
### }}}
